name: EC2 auto deploy

on:
  pull_request:
    branches: [main]
    types: [closed]

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Public IP Install
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Checkout
        uses: actions/checkout@v2

      - name: AWS CLI install
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install --update
          aws --version

      - name: AWS set Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Deploy
        env:
          EC2_SG_ID: ${{ secrets.EC2_SECURITY_GROUP_ID }}
          EC2_USER: ${{ secrets.EC2_USER_NAME }}
          EC2_HOST: ${{ secrets.EC2_HOST_NAME }}
          GIT_PRIVATE_KEY: ${{ secrets.GIT_PRIVATE_KEY }}
          RUNNER_IP: ${{ steps.ip.outputs.ipv4 }}
        run: |
          set -euo pipefail

          # 必須情報の存在チェック
          if [ -z "${EC2_SG_ID:-}" ] || [ -z "${EC2_USER:-}" ] || [ -z "${EC2_HOST:-}" ] || [ -z "${GIT_PRIVATE_KEY:-}" ]; then
            echo "ERROR: 必須の secret が不足しています。EC2_SG_ID / EC2_USER / EC2_HOST / GIT_PRIVATE_KEY を確認してください。"
            echo "EC2_SG_ID=${EC2_SG_ID:-<missing>}"
            echo "EC2_USER=${EC2_USER:-<missing>}"
            echo "EC2_HOST=${EC2_HOST:-<missing>}"
            exit 1
          fi

          # セキュリティグループを開放（失敗しても後続で閉じるよう trap をセット）
          aws ec2 authorize-security-group-ingress --group-id "${EC2_SG_ID}" --protocol tcp --port 22 --cidr "${RUNNER_IP}/32" || true
          revoke_cmd="aws ec2 revoke-security-group-ingress --group-id \"${EC2_SG_ID}\" --protocol tcp --port 22 --cidr \"${RUNNER_IP}/32\" || true"
          trap "${revoke_cmd}" EXIT

          # 秘密鍵をファイルに安全に書き出す（改行を保持）
          printf '%s\n' "$GIT_PRIVATE_KEY" > private_key
          chmod 600 private_key

          echo "Deploying to ${EC2_USER}@${EC2_HOST} from runner ${RUNNER_IP}"

          # SSH 実行（必要なら -vvv を一時的に追加してデバッグ）
          ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i private_key "${EC2_USER}@${EC2_HOST}" \
            "set -euo pipefail
             cd /algosangaku_back
             git fetch --prune
             git checkout main
             git pull origin main
             docker compose down || true
             docker compose -f compose-prod.yaml up -d --build"

          # revoke は trap が担うが、念のため明示的にも呼ぶ
          aws ec2 revoke-security-group-ingress --group-id "${EC2_SG_ID}" --protocol tcp --port 22 --cidr "${RUNNER_IP}/32" || trueURITY_GROUP_ID }} --protocol tcp --port 22 --cidr ${{ steps.ip.outputs.ipv4 }}/32
